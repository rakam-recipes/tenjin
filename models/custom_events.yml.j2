version: 2

#{% set custom_schema = import('../lib/custom_event_schema.yml') | fromyaml %}
#{% set events = import('./events.yml') | fromyaml %}

views:
  - name: product
    models:
        #{% for schema in var('custom_events') %}   
        #{% set current_schema = custom_schema[schema.event] %}
        - name: "{{schema.event}}"
          label: {{schema.event}}
          dataset: {{source('marketing', 'events')}}
          mappings: {{events.sources[0].tables[0].meta.rakam.mappings | toyaml}}
          relations: {{events.sources[0].tables[0].meta.rakam.relations | toyaml}}
          {% set measures = current_schema.measures.update(events.sources[0].tables[0].meta.rakam.measures) %}
          measures: {{measures | toyaml}}
          always_filters:
            - {dimension: event_type, value: "{{row.event}}", operator: equals}
          columns: {{events.sources[0].tables[0].columns | toyaml}}
        #{% endfor %}